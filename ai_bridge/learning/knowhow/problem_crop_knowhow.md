# 문제 이미지 추출 (Problem Crop) - 학습 노하우

## 📅 작성일: 2024-12-26

---

## 🎯 목표
교재 페이지 이미지에서 개별 문제를 추출하여 "틀린 문제 모아보기" 기능 구현

---

## ❌ 실패한 접근법들

### 1. OCR 먼저 → AI 나중 (실패)
```
OCR → "7, 0.666, 8, 0.327..." (숫자 다 섞임)
  ↓
AI → "이 중에 문제번호?" (혼란)
```
- 문제점: 문제번호, 보기번호, 수식 속 숫자 구분 불가

### 2. AI한테 "알아서 찾아줘" (부정확)
```
AI → "대략 y=40%쯤 시작할듯"
  ↓
Crop → 일부 잘림, 검증 실패
```
- 결과: 87.5% (7/8) - 일부 문제 잘림

### 3. Y좌표만 사용 (병렬 무시)
```
문제 배치:
| 1 | 4 |
| 2 | 5 |
| 3 | 6 |

Y좌표만 → 1, 4 같이 잘림 (X좌표 무시)
```

---

## ✅ 성공한 접근법

### 핵심: DB에 미리 좌표 저장 + 넉넉한 margin

```
1. 책 DB 구축 시: AI가 페이지 분석 → 대략적 좌표 저장
2. 문제 추출 시: DB 좌표 + margin 10% → Crop
3. 겹침 OK: 8번 볼 때 7번 끝, 9번 시작 좀 보여도 상관없음!
```

**결과: 100% (7/7) 검증 통과!**

---

## 💡 핵심 인사이트

### 1. 겹침은 상관없다!
```
❌ 잘못된 생각: "8번만 딱 잘라야지"
✅ 올바른 생각: "8번이 잘 보이면 되지"
```

### 2. AI 역할 분담
| 단계 | AI 역할 |
|------|---------|
| DB 구축 | 대략적 좌표 추측 (정확 안 해도 됨) |
| Crop | 단순 계산 (margin 추가) |
| 검증 | "N번 문제 보여?" → yes/no |

### 3. 필수 정보 (페이지 DB)
```dart
PageDB {
  page: 7,
  columns: 2,              // 1열 or 2열
  leftProblems: [7,8,9],   // 왼쪽 문제들
  rightProblems: [10,11,12,13],  // 오른쪽 문제들
  problems: [
    { number: "7", column: "left", yStart: 2, yEnd: 22 },
    { number: "8", column: "left", yStart: 24, yEnd: 38 },
    ...
  ]
}
```

### 4. Margin 설정
- 권장: **5~10%**
- 너무 작으면: 문제 잘림
- 너무 크면: 상관없음 (겹쳐도 OK)

---

## 📚 책 DB 구축 플로우

```
1. 정답지 촬영
   → AI가 문제번호 + 정답 추출
   
2. 각 페이지 촬영/PDF
   → AI에게 질문:
   "이 페이지 분석해줘:
    - 몇 열?
    - 왼쪽에 몇 번~몇 번?
    - 오른쪽에 몇 번~몇 번?
    - 각 문제 대략 y좌표 몇 %?"

3. AI 응답 → DB 저장 (대략적이어도 OK)

4. 문제 추출 시:
   - DB에서 좌표 조회
   - margin 10% 추가
   - Crop → 검증
```

---

## 🔧 구현 코드 위치

- 테스트 페이지: `lib/features/textbook/ocr_test_page.dart`
- Claude API: `lib/shared/services/claude_api_service.dart`
  - `detectProblemsWithLayout()` - 페이지 분석
  - `verifyCroppedProblem()` - Crop 검증

---

## 📊 테스트 결과 비교

| 방식 | 검증 통과율 |
|------|------------|
| AI 실시간 추측 | 87.5% (7/8) |
| **DB + margin** | **100% (7/7)** |

---

## 🚀 다음 단계

1. PDF 업로드 → 자동 페이지 분석 UI
2. AI 분석 결과 → DB 저장
3. 틀린 문제 기록 시 자동 Crop
4. "틀린 문제 모아보기" 화면 구현
