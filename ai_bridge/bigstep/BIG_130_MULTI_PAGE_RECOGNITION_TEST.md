# BIG_130: 청크당 다중 페이지 인식 + 실패 로그 상세화 테스트

> 생성일: 2026-01-03
> 목표: PDF 청크당 여러 페이지 인식 + 실패 원인 상세 로그 확인

---

## ⚠️ 작성 전 체크리스트 (Desktop Opus 필수 확인!)

> 이 체크리스트 완료 전에 스몰스텝 작성 금지!

### 기본 확인
- [x] 로컬 코드 확인했나? → claude_api_service.dart 프롬프트 수정 완료
- [x] 수정할 파일/줄 번호 특정했나? → 이미 수정 완료, 테스트만 필요
- [x] **새 함수/로직에 safePrint 로그 추가 지시했나?** → 실패 로그 상세화 추가됨

### 테스트 환경
- [x] 테스트 계정 리셋 필요한가? → 불필요
- [x] 빌드 필요한가? → 예 (코드 수정됨)
- [x] 듀얼 빌드 필요한가? → 불필요 (폰 단독)

### 플로우 확인
- [x] **진입 경로 전체 확인했나?** → 내 책 → Grammar Effect → 정답지 등록 → PDF 업로드
- [x] **영향 범위 확인했나?** → extractPdfWithTocValidation만 영향

---

## ⚠️ 사이드 이펙트 체크리스트 (필수!)

### 테스트 시 로그 분석
- [ ] 예상과 다른 값 나오면 즉시 원인 추적
- [ ] "왜 이 값이 나왔지?" 질문하고 답 찾기
- [ ] 이상한 로그는 보고서에 "문제점"으로 기록
- [ ] **실패 로그 상세 내용 반드시 기록**

---

## ⚠️ 필수: 템플릿 먼저 읽기!

**작업 전에 반드시 ai_bridge/templates/BIGSTEP_TEMPLATE.md 읽고 체크리스트 확인할 것!**

---

## 환경

- 프로젝트: C:\gitproject\EDU-VICE-Attendance
- 수정 파일: claude_api_service.dart (이미 수정 완료)
- 테스트 계정: maknae12@gmail.com

---

## 🎯 기대 결과 & 테스트 시나리오

### 수정 내용 요약

**1. 프롬프트 수정 (extractPdfWithTocValidation)**
- "가장 중요: 모든 교재 페이지 찾아라" 강조
- "1개만 찾지 말고" 명시적 경고
- 예시에 2개 페이지 (p.9, p.11) 포함
- `totalPagesFound` 필드 추가

**2. 실패 로그 상세화**
- 기존: `⚠️ 교차 검증 실패 → 결과에서 제외`
- 수정: 실패 원인별 상세 로그 (API 실패 vs 클라이언트 실패)
- 목차 범위별로 왜 실패했는지 표시

### 기대 로그 (성공 시)
```
[PDF분석] analysis: totalPagesFound=3
[PDF분석] ✓ 교차 검증 통과: p.9 (목차: Unit 01 문장을 이루는 요소)
[PDF분석] ✓ 교차 검증 통과: p.11 (목차: Unit 02 1형식, 2형식)
[PDF분석] ========== 분석 완료: 3페이지 ==========
```

### 기대 로그 (실패 시 - 상세해야 함!)
```
[PDF분석] ========== 교차 검증 실패 상세 ==========
[PDF분석] ❌ 제외된 페이지: p.2 (Unit 01 문장을 이루는 요소)
[PDF분석] ❌ API 실패 원인: tocMatched=false (API가 목차 매칭 실패 판정)
[PDF분석] ❌ 클라이언트 실패 원인: p.2이 어떤 목차 범위에도 포함 안 됨
[PDF분석]    검사한 목차 범위들:
[PDF분석]    - Unit 01 문장을 이루는 요소: p.8~9 ✗
[PDF분석]    - Unit 02 1형식, 2형식: p.10~11 ✗
[PDF분석] ================================================
```

### 테스트 시나리오
```
1. Grammar Effect 책 선택 → 정답지 등록 화면 진입
2. 기존 정답지 초기화 (있으면)
3. PDF 업로드 버튼 클릭 → 정답지 PDF 선택
4. 콘솔 로그에서 확인:
   - "totalPagesFound" 값 (청크당 몇 개 찾았는지)
   - "✓ 교차 검증 통과" 로그 (성공한 페이지들)
   - "❌ 제외된 페이지" 로그 (실패한 페이지들 + 상세 원인)
5. "인식 결과 확인" 다이얼로그 → 10개 이상 페이지 표시되면 성공
```

---

## 스몰스텝 (진행 시 체크박스 업데이트!)

### 1. flutter analyze
- [ ] `cd C:\gitproject\EDU-VICE-Attendance\flutter_application_1`
- [ ] `flutter analyze 2>&1 | tail -20`
- [ ] 에러 0개 확인

### 2. 폰 빌드 및 테스트
- [ ] `flutter run -d RFCY40MNBLL`
- [ ] 앱 실행 후 maknae12@gmail.com 로그인
- [ ] 내 책 → Grammar Effect 선택
- [ ] 정답지 등록 화면 진입
- [ ] (기존 정답지 있으면) 초기화 버튼 클릭

### 3. PDF 업로드 테스트
- [ ] PDF 업로드 버튼 클릭
- [ ] Grammar Effect 정답지 PDF 선택
- [ ] 콘솔 로그 관찰

### 4. 로그 확인 (핵심!)

**A. 청크당 다중 페이지 인식 확인:**
```
[PDF분석] analysis: totalPagesFound=N  (N > 1이어야 함!)
```
- [ ] totalPagesFound가 2 이상인 청크가 있음

**B. 성공 로그 확인:**
```
[PDF분석] ✓ 교차 검증 통과: p.XX (목차: YYY)
```
- [ ] 여러 페이지에서 "교차 검증 통과" 로그 있음

**C. 실패 로그 상세 확인 (중요!):**
```
[PDF분석] ========== 교차 검증 실패 상세 ==========
[PDF분석] ❌ 제외된 페이지: p.XX (Unit명)
[PDF분석] ❌ API/클라이언트 실패 원인: ...
[PDF분석]    검사한 목차 범위들:
[PDF분석]    - Unit 01: p.8~9 ✗
[PDF분석] ================================================
```
- [ ] 실패 시 "교차 검증 실패 상세" 블록이 출력됨
- [ ] 실패 원인 (API vs 클라이언트)이 명확히 표시됨
- [ ] 목차 범위별 비교 결과가 표시됨

### 5. UI 확인
- [ ] "인식 결과 확인 (N페이지)" 다이얼로그 표시됨
- [ ] **N이 10개 이상** (이전보다 많아야 함!)
- [ ] 각 페이지 내용 정상 표시

### 6. 로그 저장 (필수!)
- [ ] 콘솔에서 `[PDF분석]` 관련 로그 **전체** 복사
- [ ] `ai_bridge/logs/big_130_test.log` 파일에 저장
- [ ] **특히 실패 로그 상세 블록 반드시 포함**

### 7. 보고서 작성
- [ ] `ai_bridge/report/big_130_report.md` 작성
- [ ] 포함 내용:
  - totalPagesFound 값들 (청크별)
  - 성공한 페이지 수 & 목록
  - **실패한 페이지 수 & 실패 원인 분석**
  - UI 결과 (인식된 페이지 수)
  - 성공/실패 판정

---

## 검증 규칙 (v7.3)

- 에러 메시지만 보고 실패 판정 금지
- 실제 화면/동작 확인 후 판정
- **로그에서 "교차 검증 실패 상세" 키워드 반드시 확인**
- **실패 원인이 명확히 나오지 않으면 버그로 보고**

---

## ⚠️ Opus 필수: 로그 직접 확인!

**보고서만 읽지 말고, 로그 파일도 직접 확인할 것!**

```
확인할 로그:
- ai_bridge/logs/big_130_test.log
- Flutter 콘솔의 [PDF분석] 로그
```

**로그에서 확인할 것:**
1. `totalPagesFound` 값이 2 이상인 청크가 있나?
2. `✓ 교차 검증 통과` 로그가 여러 개 있나?
3. `❌ 제외된 페이지` 로그에 상세 원인이 나오나?
4. 목차 범위별 비교 결과(`p.X~Y ✓/✗`)가 표시되나?

---

## ⚠️ 컨텍스트 관리 (CLI 오버플로우 방지)

### 필수 규칙
1. **스몰스텝 1~2개 완료할 때마다 /compact 실행**
2. **로그는 필터링** - `grep "[PDF분석]"` 사용

---

## 완료 조건

1. flutter analyze 에러 0개
2. 콘솔 로그에서 `totalPagesFound > 1`인 청크 확인
3. 콘솔 로그에서 "교차 검증 통과" 다수 확인
4. 콘솔 로그에서 실패 시 **상세 원인** 출력 확인
5. UI에서 **10개 이상 페이지** 인식 확인
6. CP가 "테스트 종료" 입력
7. **로그 저장 완료** (ai_bridge/logs/big_130_test.log)
8. 보고서 작성 완료 (ai_bridge/report/big_130_report.md)
9. /compact 실행
